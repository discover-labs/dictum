tables:
  invoice_items:
    source: invoice_items

    related:
      invoice:
        table: invoices
        foreign_key: InvoiceId
      track:
        table: tracks
        foreign_key: TrackId

    measures:
      # revenue is defined as a metric in project.yml
      revenue:
        name: Revenue
        expr: sum(UnitPrice * Quantity)
        missing: 0
        type: float
        format: currency

      music_revenue:
        name: Music Revenue
        description: |
          Revenue, but only for music files. Used for demonstrating
          filtered measures.
        expr: $revenue
        format: currency
        filter: track.MediaTypeId in (1, 2, 4, 5)

      unique_paying_customers:
        name: Unique Paying Customers
        expr: countd(invoice.CustomerId)
        description: |
          Number of unique users who made an order.
        type: int

      items_sold:
        name: Number of Items Sold
        expr: sum(Quantity)
        type: int

      arppu:
        name: Average Revenue per Paying Customer
        expr: $revenue / $unique_paying_customers
        type: float
        format: currency

      avg_sold_unit_price:
        name: Averate Sold Unit Price
        description: Average price of a track that we sold.
        expr: $revenue / $items_sold
        type: float
        format: currency


    dimensions:
      order_customer_country:
        name: Order's Customer Country
        description: Duplicate of Customer Country, used for tests
        type: str
        expr: :customer_country

      first_order_cohort_month:
        name: Month After First Order
        type: int
        expr: datediff('month', :customer_first_sale_date, :invoice_date)

      order_cohort:
        name: Months Since First Order
        type: int
        expr: datediff('month', :customer_first_sale_date, :invoice_date)
